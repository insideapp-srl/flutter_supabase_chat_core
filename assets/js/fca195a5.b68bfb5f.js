"use strict";(self.webpackChunkflutter_supabase_chat_core=self.webpackChunkflutter_supabase_chat_core||[]).push([[992],{4318:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"guides/supabase-triggers","title":"Database Triggers","description":"Update room last message","source":"@site/docs/guides/supabse-trigges.md","sourceDirName":"guides","slug":"/guides/supabase-triggers","permalink":"/guides/supabase-triggers","draft":false,"unlisted":false,"editUrl":"https://github.com/insideapp-srl/flutter_supabase_chat_core/docs/guides/supabse-trigges.md","tags":[],"version":"current","frontMatter":{"id":"supabase-triggers","title":"Database Triggers"},"sidebar":"tutorialSidebar","previous":{"title":"Security Rules","permalink":"/guides/supabase-security"},"next":{"title":"Database Views","permalink":"/guides/supabase-views"}}');var a=t(4848),r=t(8453);const i={id:"supabase-triggers",title:"Database Triggers"},o=void 0,d={},c=[{value:"Update room last message",id:"update-room-last-message",level:2},{value:"Set message status to sent",id:"set-message-status-to-sent",level:2},{value:"Handle new user from <code>auth.users</code>",id:"handle-new-user-from-authusers",level:2}];function l(e){const s={code:"code",h2:"h2",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(s.h2,{id:"update-room-last-message",children:"Update room last message"}),"\n",(0,a.jsxs)(s.p,{children:["This is a trigger that sets room's ",(0,a.jsx)(s.code,{children:"lastMessages"})," to the most recent message sent once recieved in Supabase."]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:'CREATE OR REPLACE FUNCTION chats.update_last_messages()\n    RETURNS TRIGGER\n    SET search_path = \'\'\nAS $$\nDECLARE\n    latest_message jsonb;\n    ts_in_milliseconds bigint;\n    affected_room_id bigint;\nBEGIN\n    IF TG_OP = \'DELETE\' THEN\n        affected_room_id := OLD."roomId";\n    ELSE\n        affected_room_id := NEW."roomId";\n    END IF;\n\n    SELECT to_jsonb(m)\n    INTO latest_message\n    FROM chats.messages m\n    WHERE m."roomId" = affected_room_id\n    ORDER BY m."createdAt" DESC\n    LIMIT 1;\n\n    IF latest_message IS DISTINCT FROM (\n        SELECT value FROM jsonb_array_elements(\n                (SELECT "lastMessages" FROM chats.rooms WHERE id = affected_room_id)\n                          ) LIMIT 1\n    ) THEN\n        SELECT EXTRACT(epoch FROM NOW()) * 1000 INTO ts_in_milliseconds;\n\n        UPDATE chats.rooms\n        SET "updatedAt" = ts_in_milliseconds,\n            "lastMessages" = jsonb_build_array(latest_message)\n        WHERE id = affected_room_id;\n    END IF;\n\n    IF TG_OP = \'DELETE\' THEN\n        RETURN OLD;\n    ELSE\n        RETURN NEW;\n    END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\ndrop trigger if exists update_last_messages_trigger on chats.messages;\nCREATE TRIGGER update_last_messages_trigger\n    AFTER INSERT OR UPDATE OR DELETE ON chats.messages\n    FOR EACH ROW\nEXECUTE FUNCTION chats.update_last_messages();\n'})}),"\n",(0,a.jsx)(s.h2,{id:"set-message-status-to-sent",children:"Set message status to sent"}),"\n",(0,a.jsxs)(s.p,{children:['"This trigger, on the other hand, is responsible for setting the message status to ',(0,a.jsx)(s.code,{children:"sent"})," when it is added to the ",(0,a.jsx)(s.code,{children:"messages"})," table:"]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:"CREATE OR REPLACE FUNCTION chats.set_message_status_to_sent()\n    RETURNS TRIGGER\n    SET search_path = ''\nAS $$\nBEGIN\n    NEW.status := 'sent';\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\ndrop trigger if exists update_status_before_insert on chats.messages;\nCREATE TRIGGER update_status_before_insert\n    BEFORE INSERT ON chats.messages\n    FOR EACH ROW EXECUTE FUNCTION chats.set_message_status_to_sent();\n"})}),"\n",(0,a.jsxs)(s.h2,{id:"handle-new-user-from-authusers",children:["Handle new user from ",(0,a.jsx)(s.code,{children:"auth.users"})]}),"\n",(0,a.jsxs)(s.p,{children:['"This trigger, is responsible for replicate ',(0,a.jsx)(s.code,{children:"auth.users"})," table rows in ",(0,a.jsx)(s.code,{children:"chats.users"})," table, this is to avoid exposing user data :"]}),"\n",(0,a.jsx)(s.pre,{children:(0,a.jsx)(s.code,{className:"language-sql",children:'\nCREATE OR REPLACE FUNCTION chats.handle_new_user()\n    RETURNS trigger\n    LANGUAGE \'plpgsql\'\n    COST 100\n    VOLATILE NOT LEAKPROOF SECURITY DEFINER\n    SET search_path=public\n    SET search_path = \'\'\nAS $BODY$\nDECLARE\n    ts_in_milliseconds bigint;\nBEGIN\n    SELECT EXTRACT(epoch FROM NOW()) * 1000 INTO ts_in_milliseconds;\n    insert into chats.users (id, "createdAt", "updatedAt", "lastSeen")\n    values (new.id, ts_in_milliseconds, ts_in_milliseconds, ts_in_milliseconds);\n    return new;\nend;\n$BODY$;\n\ndrop trigger if exists on_auth_user_created on auth.users;\ncreate trigger on_auth_user_created\n    after insert on auth.users\n    for each row execute procedure chats.handle_new_user();\n\n'})})]})}function u(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,a.jsx)(s,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},8453:(e,s,t)=>{t.d(s,{R:()=>i,x:()=>o});var n=t(6540);const a={},r=n.createContext(a);function i(e){const s=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),n.createElement(r.Provider,{value:s},e.children)}}}]);